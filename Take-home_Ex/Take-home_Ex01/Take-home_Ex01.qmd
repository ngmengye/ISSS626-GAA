---
title: "Take-home Exercise 1: Geospatial Analytics for Public Good"
author: "Ng Meng Ye"
date-modified:  "2024-09-03"
date: 2024-09-03
---

## 1 Overview

Thailandâ€™s roads are the deadliest in Southeast Asia and among the worst in the world, according to the World Health Organisation. About 20,000 people die in road accidents each year, or about 56 deaths a day (WHO).

## 2 Getting Started

### 2.1 Objectives

In view of this, we need discover factors affecting road traffic accidents in the Bangkok Metropolitan Region BMR by employing both spatial spatio-temporal point patterns analysis methods.

The specific objectives of this take-home exercise are as follows:

-   To visualize the spatio-temporal dynamics of road traffic accidents in BMR using appropriate statistical graphics and geovisualization methods.

-   To conduct detailed spatial analysis of road traffic accidents using appropriate Network Spatial Point Patterns Analysis methods.

-   To conduct detailed spatio-temporal analysis of road traffic accidents using appropriate Temporal Network Spatial Point Patterns Analysis methods.

### 2.2 The Study Area

The focus of this study would in the Bangkok Metropolitan Region BMR, which includes the provinces:

1.  Bangkok

2.  Nonthaburi

3.  Nakhon Pathom

4.  Pathum Thani

5.  Samut Prakan

6.  Samut Sakhon

## 3 Data Preparation

### 3.1 Geospatial

These data sets are in `shp` format

-   Thailand Roads, available publicly from [HDX](https://data.humdata.org/dataset/hotosm_tha_roads)
-   Thailand - Subnational Administrative Boundaries, available publicly from [HDX](https://data.humdata.org/dataset/cod-ab-tha?)

This data sets are in `csv` format

-   Thailand Road Accident \[2019-2022\], available publicly from [Kaggle](https://www.kaggle.com/datasets/thaweewatboy/thailand-road-accident-2019-2022)

```{r}
#| output: false
set.seed(1234)
pacman::p_load(sf,raster,spatstat,tmap,tidyverse,sp,maptools,spNetwork)
```

## 4 Data Wrangling

### Thailand Road Accident 2019-2022

#### Importing Attribute Data into R

We will import thai_road_accident_2019_2022.csv file into RStudio and save the file into an R dataframe called rdacc

```{r}
rdacc <- read_csv("C:/ngmengye/ISSS626-GAA/Take-home_Ex/Take-home_Ex01/data/aspatial/thai_road_accident_2019_2022.csv")
```

#### Filtering missing values

To define the geometry of each point, we need to use the latitude and longitude coordinates. Before converting the data frame to an `sf` object, we need to ensure that there are no missing values in the latitude and longitude columns.

Since only 359 out of 81,735 rows have missing values, it is reasonable to remove them.

```{r}
lat_na <- sum(is.na(rdacc$latitude))
long_na <- sum(is.na(rdacc$longitude))

total_rows <- nrow(rdacc)

lat_na_pct <- (lat_na / total_rows) * 100
long_na_pct <- (long_na / total_rows) * 100

cat("Missing values in Latitude:", lat_na, "(", round(lat_na_pct, 2), "% )\n")
cat("Missing values in Longitude:", long_na, "(", round(long_na_pct, 2), "% )\n")

```

#### Creating a simple feature data frame from an aspatial data frame

The code chunk below converts `rdacc` data frame into a simple feature data frame by using `st_as_st()` of **sf** packages

```{r}
# filter out NA or missing data of longitude and latitude
# check how many missing values (make sure less than 25%)
rdacc_sf <- rdacc %>% 
  filter(!is.na(longitude) & longitude != "",
         !is.na(latitude)& latitude != "") %>% 
  st_as_sf(coords = c(
    "longitude", "latitude"),
    crs = 4326) %>% 
  st_transform(crs = 32647)
```

::: callout-caution
### Correcting the projection

`EPSG: 4326` is wgs84 Geographic Coordinate System and `EPSG: 32647` refers to the WGS 84 / UTM zone 47N Projected Coordinate System, which is specifically used for areas in Thailand.
:::

#### Plotting the Aspatial Data

We use `st_geometry` to display basic information of the feature class such as type of geometry. It looks like the plot is showing points scattered across a wide area, which suggests that your data includes locations outside the Bangkok Metropolitan Region (BMR).

```{r}
plot(st_geometry(rdacc_sf))
```

To focus only on data within the BMR, we need to filter the dataset for coordinates that fall within the region.

```{r}
rdacc_bmr_sf <- rdacc_sf %>%
  filter(province_en %in% c("Bangkok", "Nonthaburi", "Nakhon Pathom", "Pathum Thani", "Samut Prakan", "Samut Sakhon"))
```

Our plot now shows road accident points within the Bangkok Metropolitan Region (BMR) overlaid on the road network. This looks much better than the previous scattered points across a broader region.

```{r}
plot(st_geometry(rdacc_bmr_sf))
```

### Thailand Roads

#### Importing Geospatial Data

We will import `hotosm_tha_roads_lines` shapefile into RStudio as sf data frames.

```{r}
network <- st_read(dsn="C:/ngmengye/ISSS626-GAA/Take-home_Ex/Take-home_Ex01/data/geospatial", 
                   layer="hotosm_tha_roads_lines_shp")
```

```{r}
network <- st_set_crs(network, 4326)
```

```{r}
network32647 <- st_transform(network,32647)
```

```{r}
network32647
```

To see the type of highway

```{r}
unique_values <- unique(network32647$highway)

print(unique_values)
```

According to [Highway classification on WikiProject Thailand](https://wiki.openstreetmap.org/wiki/WikiProject_Thailand#Highway_classification), we should only include urban and local road wide enough for motor cars:

1 secondary \
2 residential \
3 secondary_link \
4 service \
5 tertiary \
6 trunk \
7 trunk_link \
8 primary \
9 primary_link \
10 motorway_link \
11 tertiary_link \
12 motorway \
13 road \
14 living_street

```{r}
highway_types <- c(
"secondary", "tertiary","trunk", "primary", "motorway", "unclassified"
)

# highway_types <- c(
# "secondary", "residential", "secondary_link", "tertiary",
# "trunk", "trunk_link", "primary", "primary_link", "motorway_link",
# "tertiary_link", "motorway", "road", "living_street", "unclassified"
# )


#highway_types <- c("motorway")

filtered_network <- network32647 %>%
  filter(highway %in% highway_types)
```


### Thailand - Subnational Administrative Boundaries

#### Importing Geospatial Data

Thailand administrative level 0 (country), 1 (province), 2 (district), and 3 (sub-district, tambon) boundaries. Since we focus on Bangkok Metropolitan Region, we should import level 1 (province) data. We will import `tha_admbnda_adm1_rtsd_20220121` shapefile into RStudio as sf data frames.

```{r}
thai_map <- st_read(dsn="C:/ngmengye/ISSS626-GAA/Take-home_Ex/Take-home_Ex01/data/geospatial", 
                   layer="tha_admbnda_adm1_rtsd_20220121")
```

```{r}
thai_map_32647 <- st_transform(thai_map, crs = 32647)
```

```{r}
st_crs(thai_map_32647)
```

```{r}
thaiBMR <- thai_map_32647 %>%
  filter(ADM1_EN %in% c("Bangkok", "Nonthaburi", "Nakhon Pathom", "Pathum Thani", "Samut Prakan", "Samut Sakhon"))
```

```{r}
thaiBMR
```
#### Visualizing the Geospatial Data
```{r}
plot(st_geometry(thaiBMR))
plot(rdacc_bmr_sf$geometry,add=T,col='red',pch = 19)
```

```{r}
# tmap_mode('view')
# tm_shape(thaiBMR) + tm_polygons()+
#   tm_shape(rdacc_bmr_sf$geometry) + 
#   tm_dots()
  
```

```{r}
BMR_network <- st_intersection(filtered_network,thaiBMR)

```

```{r}
# Plot the background (BMR and highways)
plot(st_geometry(thaiBMR), col = "lightblue", main = "BMR with Highways")
plot(st_geometry(BMR_network), col = "black", add = TRUE)

# Add dots for road accidents with smaller size
plot(rdacc_bmr_sf, add = TRUE, col = 'red', pch = 19, cex = 0.5)  # cex = 0.5 makes the dots smaller


```
## 5 Network Constrained Spatial Point Patterns Analysis

### 5.1 Network KDE (NKDE) Analysis

#### 5.1.1 Preparing the lixels objects

```{r}
BMR_network_linestring <- st_cast(BMR_network, "LINESTRING")
```

```{r}
lixels <- lixelize_lines(BMR_network_linestring, 10000, mindist = 5000)
```

#### 5.1.2 Generating the line centre points

```{r}
samples <- lines_center(lixels) 
```

```{r}
densities <- nkde(BMR_network_linestring, 
                  events = rdacc_bmr_sf,
                  w = rep(1, nrow(rdacc_bmr_sf)),
                  samples = samples,
                  kernel_name = "quartic",
                  bw = 30, 
                  div= "bw", 
                  method = "simple", 
                  digits = 1, 
                  tol = 1,
                  grid_shape = c(5,5), 
                  max_depth = 8,
                  agg = 5, 
                  sparse = TRUE,
                  verbose = FALSE)

```

```{r}
samples$density <- densities
lixels$density <- densities
```

```{r}
# rescaling to help the mapping# rescaling to help the mapping
samples$density <- samples$density*1000
lixels$density <- lixels$density*1000
```

```{r}
tmap_mode('view')
tm_shape(lixels)+
  tm_lines(col="density")+
tm_shape(rdacc_bmr_sf)+
  tm_dots()
tmap_mode('plot')
```

